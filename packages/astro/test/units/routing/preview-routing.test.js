import assert from 'node:assert/strict';
import { describe, it } from 'node:test';
import { getPattern } from '../../../dist/core/routing/manifest/pattern.js';
import { Router } from '../../../dist/core/routing/router.js';

const staticPart = (content) => ({ content, dynamic: false, spread: false });
const dynamicPart = (content) => ({ content, dynamic: true, spread: false });

const makeRoute = ({ segments, trailingSlash, route, pathname, isIndex = false }) => {
	const params = segments
		.flat()
		.filter((part) => part.dynamic)
		.map((part) => part.content);
	return {
		route,
		component: route,
		params,
		pathname,
		pattern: getPattern(segments, '/', trailingSlash),
		segments,
		type: 'page',
		prerender: false,
		fallbackRoutes: [],
		distURL: [],
		isIndex,
		origin: 'project',
	};
};

describe('preview routing (unit)', () => {
	const routes = (trailingSlash) => [
		makeRoute({ segments: [], trailingSlash, route: '/', pathname: '/', isIndex: true }),
		makeRoute({
			segments: [[staticPart('another')]],
			trailingSlash,
			route: '/another',
			pathname: '/another',
		}),
		makeRoute({
			segments: [[dynamicPart('id')]],
			trailingSlash,
			route: '/[id]',
			pathname: undefined,
		}),
	];

	it('matches base with trailingSlash=always', () => {
		const router = new Router(routes('always'), {
			base: '/blog',
			trailingSlash: 'always',
			buildFormat: 'directory',
		});

		assert.equal(router.match('/blog/').type, 'match');
		assert.equal(router.match('/blog').type, 'none');
		assert.equal(router.match('/blog/another/').type, 'match');
		assert.equal(router.match('/blog/another').type, 'none');
	});

	it('matches base with trailingSlash=never', () => {
		const router = new Router(routes('never'), {
			base: '/blog',
			trailingSlash: 'never',
			buildFormat: 'directory',
		});

		assert.equal(router.match('/blog').type, 'match');
		assert.equal(router.match('/blog/').type, 'none');
		assert.equal(router.match('/blog/another').type, 'match');
		assert.equal(router.match('/blog/another/').type, 'none');
	});

	it('matches base with trailingSlash=ignore', () => {
		const router = new Router(routes('ignore'), {
			base: '/blog',
			trailingSlash: 'ignore',
			buildFormat: 'directory',
		});

		assert.equal(router.match('/blog').type, 'match');
		assert.equal(router.match('/blog/').type, 'match');
		assert.equal(router.match('/blog/another').type, 'match');
		assert.equal(router.match('/blog/another/').type, 'match');
	});

	it('accepts .html paths when buildFormat=file', () => {
		const router = new Router(routes('ignore'), {
			base: '/blog',
			trailingSlash: 'ignore',
			buildFormat: 'file',
		});

		assert.equal(router.match('/blog/index.html').type, 'match');
		assert.equal(router.match('/blog/another.html').type, 'match');
		const match = router.match('/blog/1.html');
		assert.equal(match.type, 'match');
		assert.deepEqual(match.params, { id: '1' });
	});
});
